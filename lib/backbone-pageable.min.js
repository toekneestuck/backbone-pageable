/*
  backbone-pageable 1.4.2
  http://github.com/wyuenho/backbone-pageable

  Copyright (c) 2013 Jimmy Yuen Ho Wong
  Licensed under the MIT @license.
*/
!function(a){if("object"==typeof exports)module.exports=a(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],a);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var b=Backbone.PageableCollection,c=a(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=b,c}}}(function(a,b){"use strict";function c(b,c){if(!a.isNumber(b)||r(b)||!a.isFinite(b)||~~b!==b)throw new TypeError("`"+c+"` must be a finite integer");return b}function d(a){for(var b,c,d,e,f={},g=decodeURIComponent,h=a.split("&"),i=0,j=h.length;j>i;i++){var k=h[i];b=k.split("="),c=b[0],d=b[1]||!0,c=g(c),d=g(d),e=f[c],o(e)?e.push(d):f[c]=e?[e,d]:d}return f}function e(a,b,c){var d=a._events[b];if(d&&d.length){var e=d[d.length-1],f=e.callback;e.callback=function(){try{f.apply(this,arguments),c()}catch(a){throw a}finally{e.callback=f}}}else c()}var f=a.extend,g=a.omit,h=a.clone,i=a.each,j=a.pick,k=a.contains,l=a.isEmpty,m=a.pairs,n=a.invert,o=a.isArray,p=a.isFunction,q=a.isObject,r=a.isNaN,s=a.keys,t=a.isUndefined,u=a.result,v=a.bindAll,w=Math.ceil,x=Math.floor,y=Math.max,z=b.Collection.prototype,A=/[\s'"]/g,B=/[<>\s'"]/g,C=b.PageableCollection=b.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1,query:null,query_field:null,filters:null,filterMatch:null},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"},filterMatch:"match"},filterTypeDelimiter:":",clientFilters:{equal:function(a,b){return a===b.value},required:function(a){return!l(a)},min:function(a,b){var c=Number(a),d=Number(b.value);return!r(c)&&!r(d)&&c>=d},max:function(a,b){var c=Number(a),d=Number(b.value);return!r(c)&&!r(d)&&d>=c},range:function(a,b){var c=Number(a),d=b.value,e=d?Number(d.min):null,f=d?Number(d.max):null;return!r(c)&&!r(e)&&!r(f)&&c>=e&&f>=c},minlength:function(a,b){return a.toString().length>=b.value},maxlength:function(a,b){return a.toString().length<=b.value},rangelength:function(a,b){var c=a.toString(),d=b.value,e=d?Number(d.min):null,f=d?Number(d.max):null;return!r(e)&&!r(f)&&c.length>=e&&c.length<=f},includes:function(a,b){var c=b.value;return o(c)&&_include(a,c)},all:function(b,c){var d=c.value;return o(d)&&o(b)&&a.intersection(b,d).length===d.length},pattern:function(a,b){return a&&a.toString().match(b.value)},contains:function(a,b){var c=(a||"").toString();return b.caseSensitive?c.indexOf(b.value)>-1:c.match(new RegExp(b.value,"gi"))},startswith:function(a,b){return a&&a.toString().match(new RegExp("^"+b.value,"gi"))},endswith:function(a,b){return a&&a.toString().match(new RegExp(b.value+"$","gi"))}},serverFilters:{equal:"",required:"required",min:"min",max:"max",range:"range",minlength:"min",maxlength:"max",rangelength:"range_length",includes:"includes",all:"all",contains:"contains",startswith:"startswith",endswith:"endswith",pattern:"pattern"},defaultSearchField:null,constructor:function(a,b){z.constructor.apply(this,arguments),b=b||{};var c=this.mode=b.mode||this.mode||D.mode,d=f({},D.queryParams,this.queryParams,b.queryParams||{});d.directions=f({},D.queryParams.directions,this.queryParams.directions,d.directions||{}),this.queryParams=d,this.filterParams=b.filterParams||{};var e=this.state=f({},D.state,this.state,b.state||{},this.filterParams);e.currentPage=null==e.currentPage?e.firstPage:e.currentPage,o(a)||(a=a?[a]:[]),"server"==c||null!=e.totalRecords||l(a)||(e.totalRecords=a.length),p(this.url)&&v(this,"url"),this.switchMode(c,f({fetch:!1,resetState:!1,models:a},b));var g=b.comparator;if(e.sortKey&&!g&&this.setSorting(e.sortKey,e.order,b),"server"!=c){var i=this.fullCollection;g&&b.full&&(this.comparator=null,i.comparator=g),b.full&&i.sort(),a&&!l(a)&&(this.reset([].slice.call(a),f({silent:!0},b)),this.getPage(e.currentPage),a.splice.apply(a,[0,a.length].concat(this.models)))}this._initState=h(this.state)},_makeFullCollection:function(a,c){var d,e,f,g=["url","model","sync","comparator"],h=this.constructor.prototype,i={};for(d=0,e=g.length;e>d;d++)f=g[d],t(h[f])||(i[f]=h[f]);var j=new(b.Collection.extend(i))(a,c);for(d=0,e=g.length;e>d;d++)f=g[d],this[f]!==h[f]&&(j[f]=this[f]);return j},_makeCollectionEventHandler:function(a,b){return function(c,d,g,j){var k=a._handlers;i(s(k),function(c){var d=k[c];a.off(c,d),b.off(c,d)});var l=h(a.state),m=l.firstPage,n=0===m?l.currentPage:l.currentPage-1,o=l.pageSize,p=n*o,q=p+o;if("add"==c){var r,u,v,x,j=j||{};if(g==b)u=b.indexOf(d),u>=p&&q>u&&(x=a,r=v=u-p);else{r=a.indexOf(d),u=p+r,x=b;var v=t(j.at)?u:j.at+p}if(j.onRemove||(++l.totalRecords,delete j.onRemove),a.state=a._checkState(l),x){x.add(d,f({},j||{},{at:v}));var y=r>=o?d:!t(j.at)&&q>v&&a.length>o?a.at(o):null;y&&e(g,c,function(){a.remove(y,{onAdd:!0})})}}if("remove"==c)if(j.onAdd)delete j.onAdd;else{if(--l.totalRecords){var z=l.totalPages=w(l.totalRecords/o);l.lastPage=0===m?z-1:z||m,l.currentPage>z&&(l.currentPage=l.lastPage)}else l.totalRecords=null,l.totalPages=null;a.state=a._checkState(l);var A,B=j.index;if(g==a)(A=b.at(q))&&e(a,c,function(){a.push(A,{onRemove:!0})}),b.remove(d);else if(B>=p&&q>B){a.remove(d);var C=B+1;A=b.at(C)||b.last(),A&&a.add(A,{at:C,onRemove:!0})}}if("reset"==c)if(j=g,g=d,g==a&&null==j.from&&null==j.to){var D=b.models.slice(0,p),E=b.models.slice(p+a.models.length);b.reset(D.concat(a.models).concat(E),j)}else g==b&&((l.totalRecords=b.models.length)||(l.totalRecords=null,l.totalPages=null),"client"==a.mode&&(l.lastPage=l.currentPage=l.firstPage),a.state=a._checkState(l),a.reset(b.models.slice(p,q),f({},j,{parse:!1})));"sort"==c&&(j=g,g=d,g===b&&a.reset(b.models.slice(p,q),f({},j,{parse:!1}))),i(s(k),function(c){var d=k[c];i([a,b],function(a){a.on(c,d);var b=a._events[c]||[];b.unshift(b.pop())})})}},_checkState:function(a){var b=this.mode,d=this.links,e=a.totalRecords,f=a.pageSize,g=a.currentPage,h=a.firstPage,i=a.totalPages;if(null!=e&&null!=f&&null!=g&&null!=h&&("infinite"==b?d:!0)){if(e=c(e,"totalRecords"),f=c(f,"pageSize"),g=c(g,"currentPage"),h=c(h,"firstPage"),1>f)throw new RangeError("`pageSize` must be >= 1");if(i=a.totalPages=w(e/f),0>h||h>1)throw new RangeError("`firstPage must be 0 or 1`");if(a.lastPage=0===h?y(0,i-1):i||h,"infinite"==b){if(!d[g+""])throw new RangeError("No link found for page "+g)}else if(h>g||i>0&&(h?g>i:g>=i)){throw new RangeError("`currentPage` must be firstPage <= currentPage "+(h?">":">=")+" totalPages if "+h+"-based. Got "+g+".")}}return a},setPageSize:function(a,b){a=c(a,"pageSize"),b=b||{first:!1};var d=this.state,e=w(d.totalRecords/a),h=e?y(d.firstPage,x(e*(d.firstPage?d.currentPage:d.currentPage+1)/d.totalPages)):d.firstPage;return d=this.state=this._checkState(f({},d,{pageSize:a,currentPage:b.first?d.firstPage:h,totalPages:e})),this.getPage(d.currentPage,g(b,["first"]))},switchMode:function(b,c){if(!k(["server","client","infinite"],b))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');c=c||{fetch:!0,resetState:!0};var d=this.state=c.resetState?h(this._initState):this._checkState(f({},this.state));this.mode=b;var e,j=this,l=this.fullCollection,m=this._handlers=this._handlers||{};if("server"==b||l)"server"==b&&l&&(i(s(m),function(a){e=m[a],j.off(a,e),l.off(a,e)}),delete this._handlers,this._fullComparator=l.comparator,delete this.fullCollection);else{l=this._makeFullCollection(c.models||[],c),l.pageableCollection=this,this.fullCollection=l;var n=this._makeCollectionEventHandler(this,l);i(["add","remove","reset","sort"],function(b){m[b]=e=a.bind(n,{},b),j.on(b,e),l.on(b,e)}),l.comparator=this._fullComparator}if("infinite"==b)for(var o=this.links={},p=d.firstPage,q=w(d.totalRecords/d.pageSize),r=0===p?y(0,q-1):q||p,t=d.firstPage;r>=t;t++)o[t]=this.url;else this.links&&delete this.links;return c.fetch?this.fetch(g(c,"fetch","resetState")):this},hasPrevious:function(){var a=this.state,b=a.currentPage;return"infinite"!=this.mode?b>a.firstPage:!!this.links[b-1]},hasNext:function(){var a=this.state,b=this.state.currentPage;return"infinite"!=this.mode?b<a.lastPage:!!this.links[b+1]},getFirstPage:function(a){return this.getPage("first",a)},getPreviousPage:function(a){return this.getPage("prev",a)},getNextPage:function(a){return this.getPage("next",a)},getLastPage:function(a){return this.getPage("last",a)},getPage:function(a,b){var d=this.mode,e=this.fullCollection;b=b||{fetch:!1};var h=this.state,i=h.firstPage,j=h.currentPage,k=h.lastPage,m=h.pageSize,n=a;switch(a){case"first":n=i;break;case"prev":n=j-1;break;case"next":n=j+1;break;case"last":n=k;break;default:n=c(a,"index")}this.state=this._checkState(f({},h,{currentPage:n})),b.from=j,b.to=n;var o=(0===i?n:n-1)*m,p=e&&e.length?e.models.slice(o,o+m):[];return this.trigger("paginate",this,n,b),"client"!=d&&("infinite"!=d||l(p))||b.fetch?("infinite"==d&&(b.url=this.links[n]),this.fetch(g(b,"fetch"))):(this.reset(p,g(b,"fetch")),this)},getPageByOffset:function(a,b){if(0>a)throw new RangeError("`offset must be > 0`");a=c(a);var d=x(a/this.state.pageSize);return 0!==this.state.firstPage&&d++,d>this.state.lastPage&&(d=this.state.lastPage),this.getPage(d,b)},sync:function(a,c,d){var e=this;if("infinite"==e.mode){var g=d.success,h=e.state.currentPage;d.success=function(a,b,c){var i=e.links,j=e.parseLinks(a,f({xhr:c},d));i[e.state.firstPage]=j.first||i[e.state.firstPage]||null,i[h]=j[h]||i[h]||null,i[h-1]=j.prev||i[h-1]||null,i[h+1]=j.next||i[h+1]||null,g&&g(a,b,c)}}return(z.sync||b.sync).call(e,a,c,d)},parseLinks:function(a,b){var c={},e=b.xhr.getResponseHeader("Link");if(e){var f=["first","prev","previous","next","last"];i(e.split(","),function(a){var b=a.split(";"),d=b[0].replace(B,""),e=b.slice(1);i(e,function(a){var b=a.split("="),e=b[0].replace(A,""),g=b[1].replace(A,"");"rel"==e&&k(f,g)&&("previous"==g?c.prev=d:c[g]=d)})});var g,j,l=c.last||"";if(j=(g=l.indexOf("?"))?l.slice(g+1):""){var m=d(j),n=h(this.state),o=this.queryParams,p=n.pageSize,q=1*m[o.totalRecords],r=1*m[o.currentPage],s=m[o.totalPages];q||(r?q=(0===n.firstPage?r+1:r)*p:s&&(q=s*p)),q&&(n.totalRecords=q),this.state=this._checkState(n)}}return delete c.last,c},parse:function(a,b){var c=this.parseState(a,h(this.queryParams),h(this.state),b);return c&&(this.state=this._checkState(f({},this.state,c))),this.parseRecords(a,b)},parseState:function(b,c,d){if(b&&2===b.length&&q(b[0])&&o(b[1])){var e=h(d),f=b[0];return i(m(g(c,"directions")),function(b){var c=b[0],d=b[1],g=f[d];t(g)||a.isNull(g)||(e[c]=f[d])}),f.order&&(e.order=1*n(c.directions)[f.order]),e}},parseRecords:function(a){return a&&2===a.length&&q(a[0])&&o(a[1])?a[1]:a},search:function(a,b){b=b||{};var c,d=(this.state,b.field),e=g(b,["field","type"]);if(d=d||this.defaultSearchField,!d)throw new ReferenceError("No search field configured.");c=l(a)?[]:[{type:b.type||"contains",field:d,value:a}],this.currentQuery=a.length?a:null,this.trigger("search",this,a,b),this.setFilters(c,e,!0)},addFilter:function(a,b){var c=this.state.filters||[];c.push(a),this.trigger("filter:add",this,a,c,b),this.setFilters(c,b)},removeFilter:function(b,c){var d=this.state.filters||[],e=a.where(d,{field:b}),f=e?a.indexOf(d,e):!1;f&&(d.splice(f,1),this.trigger("filter:remove",this,b,d,c),this.setFilters(d,c))},setFilters:function(a,b,c){this.state.filters=[],this.state.filterMatch=null,l(a)||(this.state.filters=a,"undefined"!=typeof b&&"undefined"!=typeof b.matchAny&&(this.state.filterMatch=b.matchAny?"any":"all")),c||this.trigger("filter",this,a,b),this._processFilters(b)},_processFilters:function(a){var b=this.state,c=b.filters;switch(this.mode){case"client":this.filterOnClient(c,a);break;default:this.filterOnServer(c,a)}},filterOnClient:function(a,b){var c=[],d=this.fullCollection,e=this.fullModels||d.models;return l(a)?d.reset(e):(b=b||{},c=this.filterModels(e,a,b.matchAny),this.fullModels=this.fullModels||d.models.slice(0),d.reset(c,b))},filterModels:function(b,c,d){var e=[],f=this.clientFilters;return a.each(b,function(b){var g=!d;a.each(c||[],function(a){return!g&&!d||g&&d?!1:(g=!1,void(f[a.type]&&f[a.type](b.get(a.field),a)&&(g=!0)))}),g&&e.push(b)}),e},filterOnServer:function(b,c){var d=this.serverFilters,e=a.pluck(b,"type"),f=a.keys(d||{}),g=a.difference(e,f),h=a.difference(e,g),i={};return g.length&&window.console&&window.console.warn("The following filters will not be applied: "+g.join(", ")),b=a.filter(b,function(a){return h.indexOf(a.type)>-1}),this.state.currentPage=1,this.fetch(a.extend({},c,{data:i,filters:b,reset:!0}))},prepareServerFilterData:function(b){var c={},d=(this.queryParams,this.filterTypeDelimiter),e=this.serverFilters;return b&&b.length?(a.each(b,function(b){var f=e[b.type];c[b.field]=(f?f+d:"")+(a.isString(b.value)?b.value:JSON.stringify(b.value))}),c):c},isSearching:function(){return!!this.currentQuery},isFiltering:function(){return!l(this.state.filters)},fetch:function(b){b=b||{};var c,e=this._checkState(this.state),i=this.mode,k=b.filters||e.filters;"infinite"!=i||b.url||(b.url=this.links[e.currentPage]);var l=b.data||{},n=u(b,"url")||u(this,"url")||"",o=n.indexOf("?");-1!=o&&(f(l,d(n.slice(o+1))),n=n.slice(0,o)),b.url=n,b.data=l;var q,r,v,w,x="client"==this.mode?j(this.queryParams,"sortKey","order"):g(j(this.queryParams,s(D.queryParams)),"directions"),y=m(x),A=h(this);for(q=0;q<y.length;q++)r=y[q],v=r[0],w=r[1],w=p(w)?w.call(A):w,null!=e[v]&&null!=w&&(l[w]=e[v]);e.sortKey&&e.order?l[x.order]=this.queryParams.directions[e.order+""]:e.sortKey||delete l[x.order];var B=m(g(this.queryParams,s(D.queryParams)));for(q=0;q<B.length;q++)r=B[q],w=r[1],w=p(w)?w.call(A):w,null!=w&&(l[r[0]]=w);if(k&&(c=this.prepareServerFilterData(k),a.extend(l,c)),"server"!=i){var C=this,E=this.fullCollection,F=b.success;return b.success=function(c,d,e){e=e||{},t(b.silent)?delete e.silent:e.silent=b.silent;var g=c.models;"client"==i?E.reset(g,e):(E.add(g,f({at:E.length},a.omit(e,"parse"))),e.silent||C.trigger("reset",C,e)),F&&F(c,d,e)},z.fetch.call(C,f({},b,{silent:!0}))}return z.fetch.call(this,b)},_makeComparator:function(a,b,c){var d=this.state;return a=a||d.sortKey,b=b||d.order,a&&b?(c||(c=function(a,b){return a.get(b)}),function(d,e){var f,g=c(d,a),h=c(e,a);return 1===b&&(f=g,g=h,h=f),g===h?0:h>g?-1:1}):void 0},setSorting:function(a,b,c){var d=this.state;d.sortKey=a,d.order=b=b||d.order;var e=this.fullCollection,g=!1,h=!1;a||(g=h=!0);var i=this.mode;c=f({side:"client"==i?i:"server",full:!0},c);var j=this._makeComparator(a,b,c.sortValue),k=c.full,l=c.side;return"client"==l?k?(e&&(e.comparator=j),g=!0):(this.comparator=j,h=!0):"server"!=l||k||(this.comparator=j),g&&(this.comparator=null),h&&e&&(e.comparator=null),this}}),D=C.prototype;return C});